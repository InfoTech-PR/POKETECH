<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PokéTech</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link rel="manifest" href="/manifest.json" />
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <script src="https://cdn.jsdelivr.net/npm/drag-drop-touch@1.3.1/DragDropTouch.js"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin="" />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""></script>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap");

      /* Estilo inspirado no GBA */
      .gba-font {
        font-family: "Press Start 2P", cursive;
        text-transform: uppercase;
      }

      .gba-button {
        /* AJUSTES PARA PADRONIZAR O TAMANHO DO TEXTO */
        padding: 8px 12px; /* Diminui o padding */
        font-size: 10px; /* Padroniza o tamanho da fonte para 10px em todos os botões */
        font-weight: bold;
        color: #ffffff;
        border: 3px solid #000;
        border-radius: 8px;
        text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.5);
        transition: background-color 0.1s;
        box-shadow: inset 0 -3px 0 rgba(0, 0, 0, 0.3);
        width: 100%;
        height: 40px; /* Mantém a altura */
        line-height: 20px; /* Ajusta a altura da linha */
      }

      .gba-button:hover:not(:disabled) {
        filter: brightness(1.1);
        box-shadow: inset 0 -4px 0 rgba(0, 0, 0, 0.5);
      }

      .gba-button:disabled {
        background-color: #6b7280;
        cursor: not-allowed;
      }

      /* Esta classe já estava definida e é a chave para a rolagem interna */
      .pokemon-list-container {
        flex-grow: 1; /* Permite que o container da lista cresça e preencha o espaço */
        overflow-y: auto; /* Adiciona scrollbar se necessário */
      }

      /* Animação de balanço da pokébola */
      @keyframes shake {
        0%,
        100% {
          transform: scale(1.5) rotate(0deg);
        }
        20%,
        60% {
          transform: scale(1.5) rotate(-15deg);
        }
        40%,
        80% {
          transform: scale(1.5) rotate(15deg);
        }
      }
      .animate-spin-slow {
        animation: shake 1.2s infinite ease-in-out;
      }

      /* 1. Dano (Flash Vermelho/Branco) */
      @keyframes damage-flash {
        0% {
          filter: brightness(1);
        }
        25% {
          filter: brightness(3) contrast(2) drop-shadow(0 0 5px red);
        }
        50% {
          filter: brightness(1);
        }
        75% {
          filter: brightness(3) contrast(2) drop-shadow(0 0 5px red);
        }
        100% {
          filter: brightness(1);
        }
      }
      .animate-damage {
        animation: damage-flash 0.5s ease-out;
      }

      /* 2. Cura (Flash Verde/Branco) */
      @keyframes heal-flash {
        0% {
          filter: brightness(1);
        }
        50% {
          filter: brightness(3) contrast(2) drop-shadow(0 0 5px limegreen);
        }
        100% {
          filter: brightness(1);
        }
      }
      .animate-heal {
        animation: heal-flash 0.5s ease-out;
      }

      /* 3. Ataque (Ligeiro empurrão para frente) */
      @keyframes attack-pulse {
        0% {
          transform: translate(0, 0) scale(1.5);
        }
        50% {
          transform: translate(10px, -5px) scale(1.6);
        }
        100% {
          transform: translate(0, 0) scale(1.5);
        }
      }
      .animate-attack {
        animation: attack-pulse 0.3s ease-out;
      }

      /* 4. Ataque do Oponente (Ligeiro empurrão para baixo) */
      @keyframes opponent-attack-pulse {
        0% {
          transform: translate(0, 0) scale(1.5);
        }
        50% {
          transform: translate(-10px, 5px) scale(1.6);
        }
        100% {
          transform: translate(0, 0) scale(1.5);
        }
      }
      .animate-opponent-attack {
        animation: opponent-attack-pulse 0.3s ease-out;
      }

      /* Impede seleção de texto e ajusta touch */
      body,
      html {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
        user-select: none;
        touch-action: manipulation;
        background-color: #2d3748;
        overflow: auto; /* Scroll normal */
      }

      #app-container {
        width: 100%;
        height: 100vh; /* altura da viewport */
        padding: 0;
        box-sizing: border-box;
      }

      /* Wrapper do card */
      .gba-card-wrapper {
        display: flex;
        flex-direction: column;
        width: 100%;
        max-width: 768px; /* limitar largura em telas grandes */
        height: 100%;
        padding: 1rem;
        box-sizing: border-box;
      }

      /* Tela do jogo */
      .gba-screen {
        width: 100vw; /* ocupa toda a largura da viewport */
        height: 100vh; /* ocupa toda a altura da viewport */
        background-color: #c6c6c6;
        border-radius: 0; /* remove bordas arredondadas se quiser tela completa */
        box-shadow: none; /* opcional: remove sombra */
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        padding: 1rem;
        box-sizing: border-box;
      }

      /* NOVO ESTILO: Garante que o mapa dentro do GBA-Screen funcione */
      #map-container {
        height: 100%;
        width: 100%;
        min-height: 200px;
        background-color: #eee;
      }
    </style>
  </head>
  <body>
    <!-- BOTÃO DE FULLSCREEN -->
    <button
      id="fullscreen-btn"
      title="Tela Cheia"
      style="
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 9999;
        background-color: rgba(0, 0, 0, 0.5);
        color: #fff;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 18px;
        transition: background-color 0.2s, transform 0.2s;
      ">
      ⛶
    </button>

    <!-- BOTÃO DE UPDATES - abaixo do fullscreen -->
    <button
      id="updates-btn"
      title="Ver Updates"
      style="
        position: fixed;
        top: 60px; /* deslocado 50px abaixo do fullscreen */
        right: 10px;
        z-index: 9999;
        background-color: rgba(0, 0, 0, 0.5);
        color: #fff;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 18px;
        transition: background-color 0.2s, transform 0.2s;
      ">
      ⓘ
    </button>

    <!-- Loader global do Firebase -->
    <div id="firebase-loader" class="fixed inset-0 z-50">
      <img
        src="https://i.pinimg.com/originals/23/0c/68/230c68295a086b46a3bd01d03bef7719.gif"
        alt="Carregando Firebase..."
        class="w-full h-full object-cover" />
    </div>

    <!-- GBA Screen -->
    <div class="gba-screen">
      <!-- Conteúdo do jogo aqui -->
    </div>

    <!-- Modals (Mantidos aqui para simplificar) -->
    <div
      id="infoModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center z-50">
      <div
        class="bg-green-200 border-4 border-green-800 rounded-lg shadow-2xl p-6 w-full max-w-sm text-center max-h-[90vh] overflow-y-auto">
        <div class="text-lg font-bold text-green-800 gba-font mb-4">
          INFORMAÇÃO
        </div>
        <p class="modal-message text-sm gba-font text-green-700">
          Ação concluída.
        </p>
        <button
          onclick="window.Utils.hideModal('infoModal')"
          class="gba-button bg-green-500 hover:bg-green-600 mt-4 mx-auto w-1/2">
          OK
        </button>
      </div>
    </div>

    <div
      id="errorModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center z-50">
      <div
        class="bg-red-200 border-4 border-red-800 rounded-lg shadow-2xl p-6 w-full max-w-sm text-center max-h-[90vh] overflow-y-auto">
        <div class="text-lg font-bold text-red-800 gba-font mb-4">ERRO!</div>
        <p class="modal-message text-sm gba-font text-red-700">
          Ocorreu um erro no jogo.
        </p>
        <button
          onclick="window.Utils.hideModal('errorModal')"
          class="gba-button bg-red-500 hover:bg-red-600 mt-4 mx-auto w-1/2">
          OK
        </button>
      </div>
    </div>

    <div
      id="pokemonStatsModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center z-50">
      <div
        class="bg-gray-100 border-4 border-gray-800 rounded-lg shadow-2xl p-6 w-full max-w-sm text-center max-h-[90vh] overflow-y-auto">
        <div class="modal-body"></div>
      </div>
    </div>

    <div
      id="pvpModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center z-50">
      <div
        class="bg-gray-100 border-4 border-gray-800 rounded-lg shadow-2xl p-6 w-full max-w-sm text-center max-h-[90vh] overflow-y-auto">
        <div class="text-lg font-bold text-gray-800 gba-font mb-4">
          FIM DE BATALHA
        </div>
        <p class="modal-message text-sm gba-font">Batalha PvP terminada.</p>
        <button
          onclick="window.Utils.hideModal('pvpModal')"
          class="gba-button bg-blue-500 hover:bg-blue-600 mt-4 mx-auto w-1/2">
          OK
        </button>
      </div>
    </div>

    <!-- NOVO: Modal dedicado para a lista de amizades (para usar o listener onSnapshot) -->
    <div
      id="friendshipModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center z-50">
      <div
        class="bg-gray-100 border-4 border-gray-800 rounded-lg shadow-2xl p-6 w-full max-w-sm text-center max-h-[90vh] overflow-y-auto">
        <div class="text-lg font-bold text-gray-800 gba-font mb-4">
          LISTA DE AMIGOS
        </div>
        <div id="friendship-list-container" class="text-left">
          <!-- Conteúdo dinâmico da lista de amizades será injetado aqui -->
          <p class="text-sm gba-font text-gray-500">Carregando...</p>
        </div>
        <button
          onclick="window.PokeFriendship.stopFriendshipListener(); window.Utils.hideModal('friendshipModal')"
          class="gba-button bg-gray-500 hover:bg-gray-600 mt-4 mx-auto w-full">
          FECHAR
        </button>
      </div>
    </div>

    <!-- FULLSCREEN E UPDATE -->
    <script>
      const fullscreenBtn = document.getElementById("fullscreen-btn");
      fullscreenBtn.addEventListener("click", () => {
        if (!document.fullscreenElement) {
          document.documentElement
            .requestFullscreen()
            .catch((err) => console.warn(err));
        } else {
          document.exitFullscreen();
        }
      });

      // Hover efeito fullscreen
      fullscreenBtn.addEventListener("mouseover", () => {
        fullscreenBtn.style.backgroundColor = "rgba(0,0,0,0.7)";
        fullscreenBtn.style.transform = "scale(1.1)";
      });
      fullscreenBtn.addEventListener("mouseout", () => {
        fullscreenBtn.style.backgroundColor = "rgba(0,0,0,0.5)";
        fullscreenBtn.style.transform = "scale(1)";
      });

      const updatesBtn = document.getElementById("updates-btn");

      updatesBtn.addEventListener("click", async () => {
        let modal = document.getElementById("updatesModal");
        if (!modal) {
          modal = document.createElement("div");
          modal.id = "updatesModal";
          modal.className =
            "fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50";
          modal.innerHTML = `
            <div class="bg-gray-100 border-4 border-gray-800 rounded-lg shadow-2xl p-6 w-full max-w-md text-center max-h-[90vh] overflow-y-auto">
                <div class="text-lg font-bold gba-font mb-4">ATUALIZAÇÕES</div>
                <div id="updatesContent" class="text-left space-y-2">
                    Carregando atualizações...
                </div>
                <button id="closeUpdatesModal" class="gba-button bg-gray-700 hover:bg-gray-800 mt-4 mx-auto w-1/2">
                    FECHAR
                </button>
            </div>
        `;
          document.body.appendChild(modal);

          document
            .getElementById("closeUpdatesModal")
            .addEventListener("click", () => {
              modal.style.display = "none";
            });
        } else {
          modal.style.display = "flex";
        }

        try {
          const response = await fetch("./game_updates.json?v=" + Date.now());
          const data = await response.json();
          const updatesContent = document.getElementById("updatesContent");

          const updatesHTML = `
            <div>
                <strong class="gba-font text-green-700">Updates:</strong>
                <ul class="list-disc list-inside">
                    ${data.updates
                      .map(
                        (u) =>
                          `<li class="text-green-600">[${u.date}] ${u.text}</li>`
                      )
                      .join("")}
                </ul>
            </div>
            <div class="mt-3">
                <strong class="gba-font text-blue-700">Novidades / Pendências:</strong>
                <ul class="list-disc list-inside">
                    ${data.todos
                      .map((t) =>
                        t ? `<li class="text-blue-600">${t}</li>` : ""
                      )
                      .join("")}
                </ul>
            </div>
        `;

          updatesContent.innerHTML = updatesHTML;
        } catch (err) {
          document.getElementById("updatesContent").innerHTML =
            "<span class='text-red-600'>Falha ao carregar updates.</span>";
          console.error("Erro ao carregar game_updates.json:", err);
        }
      });

      // Hover efeito updates
      updatesBtn.addEventListener("mouseover", () => {
        updatesBtn.style.backgroundColor = "rgba(0,0,0,0.7)";
        updatesBtn.style.transform = "scale(1.1)";
      });
      updatesBtn.addEventListener("mouseout", () => {
        updatesBtn.style.backgroundColor = "rgba(0,0,0,0.5)";
        updatesBtn.style.transform = "scale(1)";
      });
    </script>

    <!-- SCRIPT PRINCIPAL E INICIALIZAÇÃO FIREBASE -->
    <script type="module">
      window.appId =
        typeof __app_id !== "undefined" ? __app_id : "default-app-id";

      // Configuração de Fallback do Firebase (do código original)
      const FALLBACK_FIREBASE_CONFIG = {
        apiKey: "AIzaSyC0Ao4MjuCmDtzIYpi1puIkel73yQFo6Is",
        authDomain: "pokemon-pvp.firebaseapp.com",
        projectId: "pokemon-pvp",
      };

      // Verifica se a variável global de configuração do Firebase existe e não está vazia.
      const providedFirebaseConfig =
        typeof __firebase_config !== "undefined" && __firebase_config;

      // Se a configuração for fornecida pelo ambiente, usa-a. Caso contrário, usa o fallback.
      window.firebaseConfig = providedFirebaseConfig
        ? JSON.parse(__firebase_config)
        : FALLBACK_FIREBASE_CONFIG;

      window.initialAuthToken =
        typeof __initial_auth_token !== "undefined"
          ? __initial_auth_token
          : null;

      // Instâncias Firebase (Serão preenchidas no js/app.js)
      window.db = null;
      window.auth = null;
      window.userId = "loading...";
      window.gameState = {};
      window.unsubscribePvp = null;

      // --- NOVO: Importação Dinâmica com Cache-Busting ---
      // Um timestamp dinâmico é adicionado ao caminho do arquivo para forçar o navegador
      // a baixar a versão mais recente em vez de usar o cache.
      const cacheBuster = Date.now();
      const appModulePath = `./js/app.js?v=${cacheBuster}`;

      window.onload = async () => {
        try {
          const { init } = await import(`./js/app.js?v=${Date.now()}`);
          await init();

          // Mantém o loader visível por 3 segundos antes de escondê-lo
          const loader = document.getElementById("firebase-loader");
          if (loader) {
            setTimeout(() => {
              loader.style.display = "none";
            }, 3000); // 3000ms = 3s
          }
        } catch (error) {
          console.error(
            "Falha ao carregar o módulo principal (app.js):",
            error
          );
        }
      };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <script>
      eruda.init();
    </script>
  </body>
</html>