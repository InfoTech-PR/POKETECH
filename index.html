<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PokéTech</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link rel="manifest" href="/manifest.json" />
    <link
      rel="apple-touch-icon"
      sizes="192x192"
      href="/assets/icons/icon-192x192.png" />
    <link
      rel="apple-touch-icon"
      sizes="512x512"
      href="/assets/icons/icon-512x512.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="PokéTech" />
    <meta name="theme-color" content="#ef4444" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="application-name" content="PokéTech" />
    <meta name="msapplication-TileColor" content="#ef4444" />
    <meta
      name="msapplication-TileImage"
      content="/assets/icons/icon-192x192.png" />
    <meta name="msapplication-config" content="none" />
    <script src="https://cdn.jsdelivr.net/npm/drag-drop-touch@1.3.1/DragDropTouch.js"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin="" />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""></script>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap");

      .gba-font {
        font-family: "Press Start 2P", cursive;
        text-transform: uppercase;
      }

      .gba-button {
        padding: 8px 12px;
        font-size: 10px;
        font-weight: bold;
        color: #ffffff;
        border: 3px solid #000;
        border-radius: 8px;
        text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.5);
        transition: background-color 0.1s;
        box-shadow: inset 0 -3px 0 rgba(0, 0, 0, 0.3);
        width: 100%;
        height: 40px;
        line-height: 20px;
      }

      .gba-button:hover:not(:disabled) {
        filter: brightness(1.1);
        box-shadow: inset 0 -4px 0 rgba(0, 0, 0, 0.5);
      }

      .gba-button:disabled {
        background-color: #6b7280;
        cursor: not-allowed;
      }

      .pokemon-list-container {
        flex-grow: 1;
        overflow-y: auto;
      }

      @keyframes shake {
        0%,
        100% {
          transform: scale(1.5) rotate(0deg);
        }
        20%,
        60% {
          transform: scale(1.5) rotate(-15deg);
        }
        40%,
        80% {
          transform: scale(1.5) rotate(15deg);
        }
      }
      .animate-spin-slow {
        animation: shake 1.2s infinite ease-in-out;
      }

      @keyframes damage-flash {
        0% {
          filter: brightness(1);
        }
        25% {
          filter: brightness(3) contrast(2) drop-shadow(0 0 5px red);
        }
        50% {
          filter: brightness(1);
        }
        75% {
          filter: brightness(3) contrast(2) drop-shadow(0 0 5px red);
        }
        100% {
          filter: brightness(1);
        }
      }
      .animate-damage {
        animation: damage-flash 0.5s ease-out;
      }

      @keyframes heal-flash {
        0% {
          filter: brightness(1);
        }
        50% {
          filter: brightness(3) contrast(2) drop-shadow(0 0 5px limegreen);
        }
        100% {
          filter: brightness(1);
        }
      }
      .animate-heal {
        animation: heal-flash 0.5s ease-out;
      }

      @keyframes attack-pulse {
        0% {
          transform: translate(0, 0) scale(1.5);
        }
        50% {
          transform: translate(10px, -5px) scale(1.6);
        }
        100% {
          transform: translate(0, 0) scale(1.5);
        }
      }
      .animate-attack {
        animation: attack-pulse 0.3s ease-out;
      }

      @keyframes opponent-attack-pulse {
        0% {
          transform: translate(0, 0) scale(1.5);
        }
        50% {
          transform: translate(-10px, 5px) scale(1.6);
        }
        100% {
          transform: translate(0, 0) scale(1.5);
        }
      }
      .animate-opponent-attack {
        animation: opponent-attack-pulse 0.3s ease-out;
      }

      body,
      html {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
        user-select: none;
        touch-action: manipulation;
        background-color: #2d3748;
        overflow: auto;
      }

      #app-container {
        width: 100%;
        height: 100vh;
        padding: 0;
        box-sizing: border-box;
      }

      .gba-card-wrapper {
        display: flex;
        flex-direction: column;
        width: 100%;
        max-width: 768px;
        height: 100%;
        padding: 1rem;
        box-sizing: border-box;
      }

      .gba-screen {
        width: 100vw;
        height: 100vh;
        background: linear-gradient(
          135deg,
          #3b82f6 0%,
          #1e40af 50%,
          #1e3a8a 100%
        );
        border-radius: 0;
        box-shadow: none;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        padding: 1rem;
        box-sizing: border-box;
      }

      #map-container {
        height: 100%;
        width: 100%;
        min-height: 200px;
        background-color: #eee;
      }
    </style>
  </head>
  <body>
    <!-- BOTÃO DE FULLSCREEN -->
    <button
      id="fullscreen-btn"
      title="Tela Cheia"
      style="
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 9999;
        background-color: rgba(0, 0, 0, 0.5);
        color: #fff;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 18px;
        transition: background-color 0.2s, transform 0.2s;
      ">
      ⛶
    </button>

    <!-- LOADING -->
    <div id="firebase-loader" class="fixed inset-0 z-50">
      <img
        src="https://i.pinimg.com/originals/23/0c/68/230c68295a086b46a3bd01d03bef7719.gif"
        alt="Carregando Firebase..."
        class="w-full h-full object-cover" />
    </div>

    <!-- GBA Screen -->
    <div class="gba-screen">
      <!-- Conteúdo do jogo aqui -->
    </div>

    <!-- INFO MODAL -->
    <div
      id="infoModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center z-50">
      <div
        class="bg-green-200 border-4 border-green-800 rounded-lg shadow-2xl p-6 w-full max-w-sm text-center max-h-[90vh] overflow-y-auto">
        <div class="text-lg font-bold text-green-800 gba-font mb-4">
          INFORMAÇÃO
        </div>
        <p class="modal-message text-sm gba-font text-green-700">
          Ação concluída.
        </p>
        <button
          onclick="window.Utils.hideModal('infoModal')"
          class="gba-button bg-green-500 hover:bg-green-600 mt-4 mx-auto w-1/2">
          OK
        </button>
      </div>
    </div>

    <!-- ERROR MODAL -->
    <div
      id="errorModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center z-50">
      <div
        class="bg-red-200 border-4 border-red-800 rounded-lg shadow-2xl p-6 w-full max-w-sm text-center max-h-[90vh] overflow-y-auto">
        <div class="text-lg font-bold text-red-800 gba-font mb-4">ERRO!</div>
        <p class="modal-message text-sm gba-font text-red-700">
          Ocorreu um erro no jogo.
        </p>
        <button
          onclick="window.Utils.hideModal('errorModal')"
          class="gba-button bg-red-500 hover:bg-red-600 mt-4 mx-auto w-1/2">
          OK
        </button>
      </div>
    </div>

    <!-- STATS MODAL -->
    <div
      id="pokemonStatsModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center z-50">
      <div
        class="bg-gray-100 border-4 border-gray-800 rounded-lg shadow-2xl p-6 w-full max-w-sm text-center max-h-[90vh] overflow-y-auto">
        <div class="modal-body"></div>
      </div>
    </div>

    <!-- PVP MODAL -->
    <div
      id="pvpModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center z-50">
      <div
        class="bg-gray-100 border-4 border-gray-800 rounded-lg shadow-2xl p-6 w-full max-w-sm text-center max-h-[90vh] overflow-y-auto">
        <div class="text-lg font-bold text-gray-800 gba-font mb-4">
          FIM DE BATALHA
        </div>
        <p class="modal-message text-sm gba-font">Batalha PvP terminada.</p>
        <button
          onclick="window.Utils.hideModal('pvpModal')"
          class="gba-button bg-blue-500 hover:bg-blue-600 mt-4 mx-auto w-1/2">
          OK
        </button>
      </div>
    </div>

    <!-- FULLSCREEN -->
    <script>
      const fullscreenBtn = document.getElementById("fullscreen-btn");
      fullscreenBtn.addEventListener("click", () => {
        if (!document.fullscreenElement) {
          document.documentElement
            .requestFullscreen()
            .catch((err) => console.warn(err));
        } else {
          document.exitFullscreen();
        }
      });

      // Hover efeito fullscreen
      fullscreenBtn.addEventListener("mouseover", () => {
        fullscreenBtn.style.backgroundColor = "rgba(0,0,0,0.7)";
        fullscreenBtn.style.transform = "scale(1.1)";
      });
      fullscreenBtn.addEventListener("mouseout", () => {
        fullscreenBtn.style.backgroundColor = "rgba(0,0,0,0.5)";
        fullscreenBtn.style.transform = "scale(1)";
      });
    </script>

    <!-- SCRIPT PRINCIPAL E INICIALIZAÇÃO FIREBASE -->
    <script type="module">
      window.appId =
        typeof __app_id !== "undefined" ? __app_id : "default-app-id";

      // Configuração de Fallback do Firebase (do código original)
      const FALLBACK_FIREBASE_CONFIG = {
        apiKey: "AIzaSyC0Ao4MjuCmDtzIYpi1puIkel73yQFo6Is",
        authDomain: "pokemon-pvp.firebaseapp.com",
        projectId: "pokemon-pvp",
      };

      // Verifica se a variável global de configuração do Firebase existe e não está vazia.
      const providedFirebaseConfig =
        typeof __firebase_config !== "undefined" && __firebase_config;

      // Se a configuração for fornecida pelo ambiente, usa-a. Caso contrário, usa o fallback.
      window.firebaseConfig = providedFirebaseConfig
        ? JSON.parse(__firebase_config)
        : FALLBACK_FIREBASE_CONFIG;

      window.initialAuthToken =
        typeof __initial_auth_token !== "undefined"
          ? __initial_auth_token
          : null;

      // Instâncias Firebase (Serão preenchidas no js/app.js)
      window.db = null;
      window.auth = null;
      window.userId = "loading...";
      window.gameState = {};
      window.unsubscribePvp = null;

      // --- NOVO: Importação Dinâmica com Cache-Busting ---
      // Um timestamp dinâmico é adicionado ao caminho do arquivo para forçar o navegador
      // a baixar a versão mais recente em vez de usar o cache.
      const cacheBuster = Date.now();
      const appModulePath = `./js/app.js?v=${cacheBuster}`;

      // Diagnóstico PWA
      window.checkPWAInstallability = async function () {
        const issues = [];
        const checks = {
          manifest: false,
          serviceWorker: false,
          icons: false,
          https: false,
        };

        // Verifica HTTPS
        if (
          location.protocol === "https:" ||
          location.hostname === "localhost" ||
          location.hostname === "127.0.0.1"
        ) {
          checks.https = true;
        } else {
          issues.push("❌ Site não está em HTTPS (obrigatório para PWA)");
        }

        // Verifica manifest
        try {
          const manifestResponse = await fetch("/manifest.json");
          if (manifestResponse.ok) {
            const manifest = await manifestResponse.json();
            checks.manifest = true;
            console.log("✅ Manifest encontrado:", manifest);

            // Verifica ícones
            if (manifest.icons && manifest.icons.length >= 2) {
              const has192 = manifest.icons.some(
                (icon) => icon.sizes === "192x192" || icon.sizes.includes("192")
              );
              const has512 = manifest.icons.some(
                (icon) => icon.sizes === "512x512" || icon.sizes.includes("512")
              );

              if (has192 && has512) {
                // Verifica tamanho real dos ícones
                const icon192 = manifest.icons.find((icon) =>
                  icon.sizes.includes("192")
                );
                const icon512 = manifest.icons.find((icon) =>
                  icon.sizes.includes("512")
                );

                if (icon192 && icon512) {
                  try {
                    const img192 = new Image();
                    await new Promise((resolve, reject) => {
                      img192.onload = () => {
                        if (
                          img192.naturalWidth >= 192 &&
                          img192.naturalHeight >= 192
                        ) {
                          checks.icons = true;
                          console.log(
                            `✅ Ícone 192x192 OK: ${img192.naturalWidth}x${img192.naturalHeight}`
                          );
                        } else {
                          issues.push(
                            `❌ Ícone 192x192 tem tamanho real ${img192.naturalWidth}x${img192.naturalHeight} (precisa ser pelo menos 192x192)`
                          );
                        }
                        resolve();
                      };
                      img192.onerror = () => {
                        issues.push(
                          `❌ Não foi possível carregar ícone 192x192: ${icon192.src}`
                        );
                        resolve();
                      };
                      img192.src = icon192.src;
                    });

                    const img512 = new Image();
                    await new Promise((resolve, reject) => {
                      img512.onload = () => {
                        if (
                          img512.naturalWidth >= 512 &&
                          img512.naturalHeight >= 512
                        ) {
                          console.log(
                            `✅ Ícone 512x512 OK: ${img512.naturalWidth}x${img512.naturalHeight}`
                          );
                        } else {
                          issues.push(
                            `❌ Ícone 512x512 tem tamanho real ${img512.naturalWidth}x${img512.naturalHeight} (precisa ser pelo menos 512x512)`
                          );
                        }
                        resolve();
                      };
                      img512.onerror = () => {
                        issues.push(
                          `❌ Não foi possível carregar ícone 512x512: ${icon512.src}`
                        );
                        resolve();
                      };
                      img512.src = icon512.src;
                    });
                  } catch (err) {
                    issues.push(
                      "❌ Erro ao verificar tamanho dos ícones: " + err.message
                    );
                  }
                }
              } else {
                issues.push(
                  "❌ Manifest precisa ter ícones de 192x192 e 512x512"
                );
              }
            } else {
              issues.push("❌ Manifest precisa ter pelo menos 2 ícones");
            }
          } else {
            issues.push("❌ Manifest.json não encontrado ou com erro");
          }
        } catch (err) {
          issues.push("❌ Erro ao carregar manifest: " + err.message);
        }

        // Verifica Service Worker
        if ("serviceWorker" in navigator) {
          try {
            const registration =
              await navigator.serviceWorker.getRegistration();
            if (registration && registration.active) {
              checks.serviceWorker = true;
              console.log("✅ Service Worker ativo");
            } else {
              issues.push("❌ Service Worker não está ativo");
            }
          } catch (err) {
            issues.push("❌ Erro ao verificar Service Worker: " + err.message);
          }
        } else {
          issues.push("❌ Service Worker não suportado neste navegador");
        }

        // Verifica beforeinstallprompt
        if (!window.deferredPrompt) {
          issues.push(
            "⚠️ Evento beforeinstallprompt não foi disparado (PWA pode não ser instalável)"
          );
        } else {
          console.log("✅ beforeinstallprompt disponível");
        }

        console.log("\n=== DIAGNÓSTICO PWA ===");
        console.log("HTTPS:", checks.https ? "✅" : "❌");
        console.log("Manifest:", checks.manifest ? "✅" : "❌");
        console.log("Service Worker:", checks.serviceWorker ? "✅" : "❌");
        console.log("Ícones:", checks.icons ? "✅" : "❌");
        if (issues.length > 0) {
          console.log("\n⚠️ PROBLEMAS ENCONTRADOS:");
          issues.forEach((issue) => console.log(issue));
        } else {
          console.log("\n✅ Todos os requisitos atendidos!");
        }

        return { checks, issues };
      };

      window.onload = async () => {
        try {
          const { init } = await import(`./js/app.js?v=${Date.now()}`);
          await init();

          // Mantém o loader visível por 3 segundos antes de escondê-lo
          const loader = document.getElementById("firebase-loader");
          if (loader) {
            setTimeout(() => {
              loader.style.display = "none";
            }, 3000); // 3000ms = 3s
          }

          // Executa diagnóstico após 5 segundos (para dar tempo do SW ativar)
          setTimeout(() => {
            if (window.checkPWAInstallability) {
              window.checkPWAInstallability();
            }
          }, 5000);
        } catch (error) {
          console.error(
            "Falha ao carregar o módulo principal (app.js):",
            error
          );
        }
      };
    </script>
  </body>
</html>
